<!DOCTYPE html>
<html lang="zh-CN" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WaypointMap Editor</title>

    <link rel="stylesheet" href="lib/leaflet/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="editor.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>

<body class="d-flex flex-column min-vh-100">

    <!-- Global Header -->
    <header class="global-header px-4">
        <div class="container-fluid d-flex justify-content-between align-items-center">
            <a href="index.html" class="brand-logo">
                <i class="bi bi-airplane-engines-fill"></i>
                WaypointMap <span class="badge bg-primary ms-2 fs-6 rounded-pill"
                    style="font-size: 0.7rem !important; vertical-align: middle;">Editor</span>
            </a>
            <nav class="d-none d-md-flex align-items-center gap-3">
                <a href="index.html" class="nav-link-custom">Home</a>
                <a href="tutorial.html" class="nav-link-custom">Tutorial</a>
                <!-- Back to Editor (Current) -->
            </nav>
        </div>
    </header>

    <!-- Editor Toolbar (Formerly Header) -->
    <div class="editor-toolbar justify-content-between">
        <div class="d-flex align-items-center">
            <span class="text-muted small fw-bold text-uppercase ls-1">Project Tools</span>
        </div>
        <div class="d-flex gap-1" id="toolbar-actions">
            <!-- Buttons moved here -->
            <button id="undoBtn" class="btn btn-dark btn-xs" title="Undo (Ctrl+Z)"><i
                    class="bi bi-arrow-counterclockwise"></i></button>
            <button id="redoBtn" class="btn btn-dark btn-xs" title="Redo (Ctrl+Alt+Z)">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
            <div class="vr mx-1 bg-secondary opacity-25"></div>
            <button id="resetBtn" class="btn btn-danger btn-xs" title="Reset All"><i class="bi bi-trash"></i></button>
            <button id="helpBtn" class="btn btn-secondary btn-xs" title="Shortcuts"><i
                    class="bi bi-keyboard"></i></button>

            <div class="vr mx-1 bg-secondary"></div>
            <span id="userInfo" class="text-light small me-2" style="display: none;"></span>
            <button id="upgradeBtn" class="btn btn-warning btn-xs ms-2 fw-bold" style="display:none;"
                data-bs-toggle="modal" data-bs-target="#proModal">
                UPGRADE
            </button>
            <button id="loginBtn" class="btn btn-outline-info btn-xs" title="Google Login">
                <i class="bi bi-google"></i> Login
            </button>
            <button id="logoutBtn" class="btn btn-outline-secondary btn-xs" title="Logout" style="display: none;">
                Logout
            </button>
        </div>
    </div>

    <!-- Main Content (Full Height - Headers) -->
    <div class="editor-main" role="main">

        <!-- Sidebar (Updated class) -->
        <div class="editor-sidebar custom-scrollbar" id="sidebar">
            <ul class="nav nav-pills nav-fill p-1 border-bottom border-secondary bg-panel" id="sideTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active btn-sm py-1" id="tab-advanced-btn" data-bs-toggle="tab"
                        data-bs-target="#tab-advanced" type="button"><i class="bi bi-sliders me-1"></i>Settings</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link btn-sm py-1" id="tab-export-btn" data-bs-toggle="tab"
                        data-bs-target="#tab-export" type="button"><i
                            class="bi bi-box-arrow-up me-1"></i>Export</button>
                </li>
            </ul>

            <div class="tab-content flex-grow-1 overflow-auto p-2 custom-scrollbar" id="tabContent">

                <div class="tab-pane fade show active" id="tab-advanced" role="tabpanel">
                    <form id="advancedForm" class="compact-form">

                        <div class="section-title">
                            <i class="bi bi-airplane-engines-fill me-1"></i> Basic
                        </div>
                        <div class="bg-dark border border-secondary rounded p-2 mb-3">
                            <div class="row g-1 mb-2">
                                <div class="col-6">
                                    <label class="form-label-xs">Drone Model</label>
                                    <select id="droneModel"
                                        class="form-select form-select-sm bg-dark text-light border-secondary">
                                        <option value="" disabled selected>Select Drone</option>
                                    </select>
                                </div>

                                <div class="col-6">
                                    <label class="form-label-xs">Camera / Payload</label>
                                    <select id="cameraModel"
                                        class="form-select form-select-sm bg-dark text-light border-secondary" disabled>
                                        <option value="">Select Model First</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row g-1">
                                <div class="col-4">
                                    <label class="form-label-xs">Units</label>
                                    <select id="units"
                                        class="form-select form-select-sm bg-dark text-light border-secondary">
                                        <option value="metric">Metric</option>
                                        <option value="imperial">Imperial</option>
                                    </select>
                                </div>
                                <div class="col-4">
                                    <label class="form-label-xs">Alt (AGL)</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" id="altitude"
                                            class="form-control bg-dark text-light border-secondary" value="90"
                                            step="1">
                                        <span
                                            class="input-group-text bg-secondary text-light border-secondary unitsLabel">m</span>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <label class="form-label-xs">Speed</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" id="speed"
                                            class="form-control bg-dark text-light border-secondary" value="9.5"
                                            step="0.1" min="1">
                                        <span class="input-group-text bg-secondary text-light border-secondary"><span
                                                class="unitsLabel">m</span>/s</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="section-title mt-3">
                            <i class="bi bi-camera-video me-1"></i> Action & Orientation
                        </div>
                        <div class="bg-dark border border-secondary rounded p-2 mb-3">
                            <div class="row g-2 mb-2">
                                <div class="col-6">
                                    <label class="form-label-xs">Action</label>
                                    <select id="action"
                                        class="form-select form-select-sm bg-dark text-light border-secondary">
                                        <option value="noAction" class="text-muted">No Action</option>
                                        <option value="takePhoto">Take Photo</option>
                                        <option value="startRecord">Start Recording</option>
                                        <option value="stopRecord">Stop Recording</option>
                                        <option value="gimbalRotate">Rotate Gimbal Only</option>
                                    </select>
                                </div>

                                <div class="col-6">
                                    <label class="form-label-xs text-warning d-flex align-items-center"
                                        title="Angle when performing action">
                                        <i class="bi bi-camera-video me-1"></i> Action Gimbal Pitch
                                    </label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" id="actionGimbalPitch"
                                            class="form-control bg-dark text-light border-secondary" value="-90"
                                            max="30" min="-90">
                                        <span class="input-group-text bg-secondary border-secondary text-light">Â°</span>
                                    </div>
                                </div>

                                <div class="col-8 mt-1">
                                    <label class="form-label-xs">Aircraft Heading</label>
                                    <select id="headingMode"
                                        class="form-select form-select-sm bg-dark text-light border-secondary">
                                        <option value="auto">Auto (Editable)</option>
                                        <option value="autoDJI">Auto (DJI)</option>
                                        <option value="fixed">Fixed Angle</option>
                                    </select>
                                </div>
                                <div class="col-4 mt-1">
                                    <label class="form-label-xs" id="headingAngleLabel"
                                        style="display:none;">Angle</label>
                                    <div id="headingInputDiv" style="display:none;">
                                        <div class="input-group input-group-sm">
                                            <input type="number" id="headingAngle"
                                                class="form-control bg-dark text-light border-secondary" value="0"
                                                placeholder="0">
                                            <span
                                                class="input-group-text bg-secondary text-light border-secondary">Â°</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="section-title mt-3"><i class="bi bi-camera me-1"></i> Photogrammetry Auto-Calc</div>
                        <div class="bg-dark border border-secondary rounded p-2 mb-3">
                            <div class="row g-1">
                                <div class="col-6 mt-1">
                                    <label class="form-label-xs">Side Overlap %</label>
                                    <input type="number" id="sideOverlap"
                                        class="form-control form-control-sm bg-dark text-light border-secondary"
                                        value="70" max="90" min="10">
                                </div>
                                <div class="col-6 mt-1">
                                    <label class="form-label-xs">Front Overlap %</label>
                                    <input type="number" id="frontOverlap"
                                        class="form-control form-control-sm bg-dark text-light border-secondary"
                                        value="70" max="90" min="10">
                                </div>
                                <div class="col-12 mt-2">
                                    <div class="d-grid">
                                        <button type="button" id="btnAutoCalc" class="btn btn-outline-info btn-sm"
                                            disabled>
                                            <i class="bi bi-calculator me-1"></i> Apply to Settings
                                        </button>
                                    </div>
                                </div>
                                <div class="col-12 mt-1 text-center">
                                    <small class="text-muted" style="font-size: 0.7rem;">
                                        GSD: <span id="gsdDisplay" class="text-light">-</span> <span
                                            id="gsdUnit">cm/px</span> |
                                        Footprint: <span id="footprintDisplay" class="text-light">-</span> <span
                                            id="footprintUnit">m</span>
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="section-title mt-3">
                            <i class="bi bi-map me-1"></i> Flight Path
                        </div>
                        <div class="bg-dark border border-secondary rounded p-2 mb-3">
                            <div class="row g-1 mb-2">
                                <div class="col-12">
                                    <small class="text-secondary fw-bold text-uppercase"
                                        style="font-size: 0.65rem;">Waypoints &amp; Placement</small>
                                </div>
                                <div class="col-4">
                                    <label class="form-label-xs">Side Spacing</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" id="spacing"
                                            class="form-control bg-dark text-light border-secondary" value="50" step="1"
                                            min="1">
                                        <span
                                            class="input-group-text bg-secondary text-light border-secondary unitsLabel">m</span>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <label class="form-label-xs">Point Interval</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" id="interval"
                                            class="form-control bg-dark text-light border-secondary" value="3"
                                            step="0.1" min="0.1">
                                        <span
                                            class="input-group-text bg-secondary text-light border-secondary unitsLabel">s</span>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <label class="form-label-xs">Direction</label>
                                    <select id="lineDirection"
                                        class="form-select form-select-sm bg-dark text-light border-secondary">
                                        <option value="auto">Auto</option>
                                        <option value="ew">East-West</option>
                                        <option value="ns">North-South</option>
                                    </select>
                                </div>
                            </div>

                            <hr class="border-secondary my-2 opacity-50">

                            <div class="mb-2">
                                <label class="form-label-xs">Turn Mode</label>
                                <select id="turnMode"
                                    class="form-select form-select-sm bg-dark text-light border-secondary"
                                    data-bs-toggle="tooltip" title="Defines how drone handles corners">
                                    <option value="toPointAndStopWithContinuityCurvature" selected>Curved Stop
                                        (Default)
                                    </option>
                                    <option value="coordinateTurn">Coordinate Turn (Fast)</option>
                                    <option value="toPointAndStopWithDiscontinuityCurvature">Straight Stop (Sharp)
                                    </option>
                                    <option value="toPointAndPassWithContinuityCurvature">Curved Pass (Smooth)
                                    </option>
                                </select>
                                <div id="turnModeHelp" class="text-secondary"
                                    style="font-size: 0.7rem; margin-top: 2px;">
                                    Curved entry, stop at point.</div>
                            </div>

                            <div class="mb-2">
                                <label class="form-label-xs">Finish Action</label>
                                <select id="finalAction"
                                    class="form-select form-select-sm bg-dark text-light border-secondary">
                                    <option value="return">Return to Home</option>
                                    <option value="hover">Hover</option>
                                    <option value="land">Auto Land</option>
                                </select>
                            </div>

                            <div class="form-check form-switch form-check-sm">
                                <input type="checkbox" id="maintainAltitude" class="form-check-input">
                                <label class="form-check-label small text-light" for="maintainAltitude">Terrain
                                    Follow</label>
                            </div>
                            <div class="form-check form-switch form-check-sm mb-3">
                                <input type="checkbox" id="reversePath" class="form-check-input">
                                <label class="form-check-label small text-light" for="reversePath">Reverse
                                    Path</label>
                            </div>

                            <button type="button" id="generateFromAdvanced"
                                class="btn btn-success btn-sm w-100 fw-bold">
                                <i class="bi bi-bezier2 me-1"></i> Generate Waypoints
                            </button>
                        </div>
                    </form>
                </div>

                <div class="tab-pane fade" id="tab-export" role="tabpanel">
                    <div class="compact-form">
                        <div class="section-title">Mission Info</div>
                        <div class="bg-dark border border-secondary rounded p-2 mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-secondary small">Count:</span>
                                <span class="text-light fw-bold small" id="wpCount">0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-secondary small">Dist:</span>
                                <span class="text-info fw-bold small" id="totalDist">0 m</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="text-secondary small">Time:</span>
                                <span class="text-warning fw-bold small" id="etaTime">0 s</span>
                            </div>
                        </div>



                        <div class="mb-3">
                            <label class="form-label-xs">Mission Name</label>
                            <input type="text" id="missionName"
                                class="form-control form-control-sm bg-dark text-light border-secondary"
                                value="DJI_Mission">
                        </div>

                        <div class="alert alert-warning py-1 px-2 small mb-3 d-flex align-items-center"
                            id="waypointWarning" style="display:none; font-size: 0.75rem;">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i> >100 WPs may lag controller.
                        </div>

                        <div class="d-grid gap-2">
                            <button id="downloadKmz" class="btn btn-primary btn-sm" disabled>
                                <i class="bi bi-download me-1"></i> Download KMZ
                            </button>
                            <button id="downloadJson" class="btn btn-outline-secondary btn-sm" disabled>
                                <i class="bi bi-file-code me-1"></i> JSON Debug
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Map Container -->
        <div class="editor-map-container" id="map-container">
            <div id="mapToast" class="map-toast">Calculation successful</div>
            <div id="map" class="h-100 w-100"></div>
        </div>

    </div>
    <!-- End editor-main -->

    <div class="modal fade" id="helpModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content bg-dark text-light border-secondary">
                <div class="modal-header border-secondary py-2">
                    <h6 class="modal-title">Shortcuts</h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body small p-3">
                    <div class="d-flex justify-content-between mb-1"><span>Polygon</span> <kbd
                            class="bg-secondary">Ctrl+1</kbd></div>
                    <div class="d-flex justify-content-between mb-1"><span>Rectangle</span> <kbd
                            class="bg-secondary">Ctrl+2</kbd></div>
                    <div class="d-flex justify-content-between mb-1"><span>Circle</span> <kbd
                            class="bg-secondary">Ctrl+3</kbd></div>
                    <hr class="border-secondary my-2">
                    <div class="d-flex justify-content-between mb-1"><span>Undo</span> <kbd
                            class="bg-secondary">Ctrl+Z</kbd></div>
                    <div class="d-flex justify-content-between"><span>Redo</span> <kbd
                            class="bg-secondary">Ctrl+Alt+Z</kbd>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="lib/leaflet/leaflet-src.js"></script>

    <div class="modal fade" id="proModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-light border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title"><i class="bi bi-star-fill text-warning me-2"></i>Upgrade to Pro</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <h3 id="planName">Loading...</h3>
                    <p id="planDesc" class="text-secondary">Please wait...</p>
                    <h2 id="planPrice" class="text-info my-3"></h2>

                    <div class="d-grid gap-2 mt-4">
                        <button id="btnSubscribe" class="btn btn-primary btn-lg" disabled>
                            Subscribe Now
                        </button>
                    </div>
                    <small class="text-muted mt-2 d-block">Secured by Stripe</small>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script src="history.js"></script>
    <script src="kmz-generator.js"></script>
    <script src="drone-specs.js"></script>
    <script src="waypoint-popup.js"></script>
    <script src="message-box.js"></script>
    <script src="drawing-manager.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            getDocs,
            collection,
            query,
            where,
            addDoc,
            onSnapshot
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 1. Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAVdsKvhztwtyv_QetEoz1nAXUejE80Sbw",
            authDomain: "waypointeditor-1238f.firebaseapp.com",
            projectId: "waypointeditor-1238f",
            storageBucket: "waypointeditor-1238f.firebasestorage.app",
            messagingSenderId: "135089930451",
            appId: "1:135089930451:web:5069920acadf6e5c695426",
            measurementId: "G-079FSLL95C"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // UI Elements
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userInfo = document.getElementById('userInfo');
        const upgradeBtn = document.getElementById('upgradeBtn');
        const btnSubscribe = document.getElementById('btnSubscribe');

        // å…¨åŸŸè®Šæ•¸å­˜ Price ID
        let currentPriceId = null;

        // --- A. ç™»å…¥èˆ‡æ¬Šé™æª¢æŸ¥é‚è¼¯ ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // å·²ç™»å…¥
                if (loginBtn) loginBtn.style.display = 'none';
                if (logoutBtn) logoutBtn.style.display = 'inline-block';
                if (userInfo) {
                    userInfo.style.display = 'inline-block';
                    userInfo.textContent = `User: ${user.email}`;
                }

                // 1. æª¢æŸ¥æ˜¯å¦å·²ç¶“è¨‚é–± (æª¢æŸ¥ users/{uid}/subscriptions å­é›†åˆ)
                checkSubscriptionStatus(user.uid);

                // 2. é å…ˆè¼‰å…¥ç”¢å“è³‡è¨Šçµ¦ Modal ç”¨
                loadProductInfo();

                // å°‡ä½¿ç”¨è€…è³‡è¨ŠæŽ›è¼‰åˆ°å…¨åŸŸè®Šæ•¸
                window.currentUser = user;

            } else {
                // æœªç™»å…¥
                if (loginBtn) loginBtn.style.display = 'inline-block';
                if (logoutBtn) logoutBtn.style.display = 'none';
                if (userInfo) userInfo.style.display = 'none';
                if (upgradeBtn) upgradeBtn.style.display = 'none';
                window.currentUser = null;
            }
        });

        // æª¢æŸ¥è¨‚é–±ç‹€æ…‹ (Extension æœƒæŠŠè³‡æ–™å¯«å…¥ subscriptions å­é›†åˆ)
        async function checkSubscriptionStatus(uid) {
            const subRef = collection(db, "users", uid, "subscriptions");
            // æ‰¾å°‹ç‹€æ…‹ç‚º active æˆ– trialing çš„è¨‚é–±
            const q = query(subRef, where("status", "in", ["active", "trialing"]));
            const snapshot = await getDocs(q);

            if (!snapshot.empty) {
                // æ˜¯ Pro ç”¨æˆ¶
                if (userInfo) {
                    userInfo.textContent = `ðŸ‘‘ Pro: ${auth.currentUser.email}`;
                    userInfo.classList.add('text-warning');
                }
                if (upgradeBtn) upgradeBtn.style.display = 'none'; // å·²ç¶“æ˜¯æœƒå“¡å°±ä¸é¡¯ç¤ºå‡ç´šéˆ•

                // è§£éŽ– App åŠŸèƒ½
                if (window.app) window.app.isProMember = true;
            } else {
                // å…è²» ç”¨æˆ¶
                if (userInfo) userInfo.classList.remove('text-warning');
                if (upgradeBtn) upgradeBtn.style.display = 'inline-block'; // é¡¯ç¤ºå‡ç´šéˆ•
                if (window.app) window.app.isProMember = false;
            }
        }

        // --- B. è®€å–ç”¢å“è³‡è¨Š (é¡¯ç¤ºåœ¨ Modal) ---
        async function loadProductInfo() {
            // è®€å– products é›†åˆä¸­ active: true çš„ç”¢å“
            const q = query(collection(db, "products"), where("active", "==", true));
            const querySnapshot = await getDocs(q);

            querySnapshot.forEach(async (doc) => {
                const product = doc.data();
                // å¡«å¯« UI
                const planName = document.getElementById('planName');
                const planDesc = document.getElementById('planDesc');
                if (planName) planName.textContent = product.name;
                if (planDesc) planDesc.textContent = product.description;

                // è®€å–é€™å€‹ç”¢å“åº•ä¸‹çš„ prices å­é›†åˆ
                const priceSnap = await getDocs(collection(db, "products", doc.id, "prices"));
                priceSnap.forEach((priceDoc) => {
                    const price = priceDoc.data();
                    // æ‰¾åˆ°ä¸€å€‹æœ‰æ•ˆçš„åƒ¹æ ¼
                    if (price.active) {
                        currentPriceId = priceDoc.id; // è¨˜ä¸‹ Price ID ä¾›çµå¸³ç”¨
                        const amount = (price.unit_amount / 100).toFixed(0); // Stripe é‡‘é¡æ˜¯ã€Œåˆ†ã€ï¼Œè¦é™¤ä»¥ 100
                        const currency = price.currency.toUpperCase();
                        const planPrice = document.getElementById('planPrice');
                        if (planPrice) planPrice.textContent = `${currency} $${amount} / month`;

                        // å•Ÿç”¨æŒ‰éˆ•
                        if (btnSubscribe) btnSubscribe.disabled = false;
                    }
                });
            });
        }

        // --- C. è§¸ç™¼çµå¸³ (æ ¸å¿ƒåŠŸèƒ½) ---
        if (btnSubscribe) {
            btnSubscribe.addEventListener('click', async () => {
                if (!auth.currentUser) return;
                if (!currentPriceId) {
                    alert("Error: No price ID found");
                    return;
                }

                btnSubscribe.textContent = "Redirecting...";
                btnSubscribe.disabled = true;

                // 1. åœ¨ users/{uid}/checkout_sessions å»ºç«‹æ–°æ–‡ä»¶
                // é€™æ˜¯å‘Šè¨´ Firebase Extensionï¼šã€Œæˆ‘è¦çµå¸³ï¼ã€
                try {
                    const sessionRef = await addDoc(collection(db, "users", auth.currentUser.uid, "checkout_sessions"), {
                        price: currentPriceId,
                        success_url: window.location.href, // ä»˜æ¬¾æˆåŠŸå¾Œè·³è½‰å›žåŽŸé é¢
                        cancel_url: window.location.href,  // å–æ¶ˆä»˜æ¬¾ä¹Ÿè·³å›žåŽŸé é¢
                    });

                    // 2. ç›£è½é€™å€‹æ–‡ä»¶ï¼Œç­‰å¾… Extension å›žå‚³ Stripe çš„ä»˜æ¬¾ç¶²å€ (url)
                    onSnapshot(sessionRef, (snap) => {
                        const data = snap.data();
                        if (!data) return;
                        const { error, url } = data;
                        if (error) {
                            // ç™¼ç”ŸéŒ¯èª¤
                            alert(`An error occurred: ${error.message}`);
                            btnSubscribe.textContent = "Subscribe Now";
                            btnSubscribe.disabled = false;
                        }
                        if (url) {
                            // 3. æ‹¿åˆ°ç¶²å€ï¼Œè·³è½‰åŽ» Stripe
                            window.location.assign(url);
                        }
                    });
                } catch (e) {
                    console.error("Checkout Error:", e);
                    alert("Checkout failed: " + e.message);
                    btnSubscribe.textContent = "Subscribe Now";
                    btnSubscribe.disabled = false;
                }
            });
        }

        // ç™»å…¥ç™»å‡ºæŒ‰éˆ•äº‹ä»¶
        if (loginBtn) loginBtn.addEventListener('click', () => signInWithPopup(auth, provider));
        if (logoutBtn) logoutBtn.addEventListener('click', () => signOut(auth).then(() => window.location.reload()));
    </script>

    <script src="app.js"></script>
</body>

</html>