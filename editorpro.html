<!DOCTYPE html>
<html lang="zh-CN" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WaypointMap Editor</title>

    <link rel="stylesheet" href="lib/leaflet/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="editor.css">
    <link rel="stylesheet" href="auth-styles.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>

<body class="d-flex flex-column min-vh-100">

    <!-- Global Header -->
    <header class="global-header px-4">
        <div class="container-fluid d-flex justify-content-between align-items-center">
            <a href="index.html" class="brand-logo">
                <i class="bi bi-airplane-engines-fill"></i>
                WaypointMap <span class="badge bg-primary ms-2 fs-6 rounded-pill"
                    style="font-size: 0.7rem !important; vertical-align: middle;">Editor</span>
            </a>
            <nav class="d-none d-md-flex align-items-center gap-3">
                <a href="index.html" class="nav-link-custom">Home</a>
                <a href="tutorial.html" class="nav-link-custom">Tutorial</a>
                <!-- Back to Editor (Current) -->

                <div class="vr mx-2 bg-secondary opacity-50"></div>

                <!-- Restored: Upgrade Button (Visible only to Free users) -->
                <button id="upgradeBtn" class="btn btn-warning btn-xs fw-bold" style="display:none;"
                    data-bs-toggle="modal" data-bs-target="#proModal">
                    UPGRADE
                </button>

                <!-- Restored: Login Button (Visible only when logged out) -->
                <button id="loginBtn" class="btn btn-outline-info btn-xs" title="Login / Register">
                    <i class="bi bi-person-circle"></i> Login
                </button>

                <!-- User Profile Dropdown (Initially Hidden) -->
                <div class="dropdown" id="userProfileDropdown" style="display: none;">
                    <button
                        class="btn btn-dark btn-xs dropdown-toggle d-flex align-items-center gap-2 border border-secondary"
                        type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <div class="user-avatar-placeholder bg-secondary text-white rounded-circle d-flex justify-content-center align-items-center"
                            style="width: 24px; height: 24px; font-size: 12px;">
                            <i class="bi bi-person-fill"></i>
                        </div>
                        <span id="currentUserEmail" class="text-light small"
                            style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">User</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark shadow border-secondary"
                        style="font-size: 0.9rem;">
                        <li>
                            <h6 class="dropdown-header text-muted text-uppercase small" style="font-size: 0.7rem;">
                                Account
                            </h6>
                        </li>
                        <li>
                            <span class="dropdown-item-text d-flex justify-content-between align-items-center">
                                Status
                                <span id="userProBadge" class="badge bg-secondary rounded-pill"
                                    style="font-size: 0.7em;">Free</span>
                            </span>
                        </li>
                        <li>
                            <hr class="dropdown-divider border-secondary opacity-50">
                        </li>
                        <li>
                            <button class="dropdown-item text-danger d-flex align-items-center gap-2" id="logoutBtn">
                                <i class="bi bi-box-arrow-right"></i> Logout
                            </button>
                        </li>
                    </ul>
                </div>
            </nav>
        </div>
    </header>

    <!-- Editor Toolbar (Formerly Header) -->
    <div class="editor-toolbar justify-content-between">
        <div class="d-flex align-items-center">
            <span class="text-muted small fw-bold text-uppercase ls-1">Project Tools</span>
        </div>
        <div class="d-flex gap-1" id="toolbar-actions">
            <!-- Buttons moved here -->
            <button id="undoBtn" class="btn btn-dark btn-xs" title="Undo (Ctrl+Z)"><i
                    class="bi bi-arrow-counterclockwise"></i></button>
            <button id="redoBtn" class="btn btn-dark btn-xs" title="Redo (Ctrl+Alt+Z)">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
            <div class="vr mx-1 bg-secondary opacity-25"></div>
            <button id="resetBtn" class="btn btn-danger btn-xs" title="Reset All"><i class="bi bi-trash"></i></button>
            <button id="helpBtn" class="btn btn-secondary btn-xs" title="Shortcuts"><i
                    class="bi bi-keyboard"></i></button>
        </div>
    </div>

    <!-- Main Content (Full Height - Headers) -->
    <div class="editor-main" role="main">

        <!-- Sidebar (Updated class) -->
        <div class="editor-sidebar custom-scrollbar" id="sidebar">
            <ul class="nav nav-pills nav-fill p-1 border-bottom border-secondary bg-panel" id="sideTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active btn-sm py-1" id="tab-advanced-btn" data-bs-toggle="tab"
                        data-bs-target="#tab-advanced" type="button"><i class="bi bi-sliders me-1"></i>Settings</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link btn-sm py-1" id="tab-export-btn" data-bs-toggle="tab"
                        data-bs-target="#tab-export" type="button"><i
                            class="bi bi-box-arrow-up me-1"></i>Export</button>
                </li>
            </ul>

            <div class="tab-content flex-grow-1 overflow-auto p-2 custom-scrollbar" id="tabContent">

                <div class="tab-pane fade show active" id="tab-advanced" role="tabpanel">
                    <form id="advancedForm" class="compact-form">

                        <div class="section-title">
                            <i class="bi bi-airplane-engines-fill me-1"></i> Basic
                        </div>
                        <div class="bg-dark border border-secondary rounded p-2 mb-3">
                            <div class="row g-1 mb-2">
                                <div class="col-6">
                                    <label class="form-label-xs">Drone Model</label>
                                    <select id="droneModel"
                                        class="form-select form-select-sm bg-dark text-light border-secondary">
                                        <option value="" disabled selected>Select Drone</option>
                                    </select>
                                </div>

                                <div class="col-6">
                                    <label class="form-label-xs">Camera / Payload</label>
                                    <select id="cameraModel"
                                        class="form-select form-select-sm bg-dark text-light border-secondary" disabled>
                                        <option value="">Select Model First</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row g-1">
                                <div class="col-4">
                                    <label class="form-label-xs">Units</label>
                                    <select id="units"
                                        class="form-select form-select-sm bg-dark text-light border-secondary">
                                        <option value="metric">Metric</option>
                                        <option value="imperial">Imperial</option>
                                    </select>
                                </div>
                                <div class="col-4">
                                    <label class="form-label-xs">Alt (AGL)</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" id="altitude"
                                            class="form-control bg-dark text-light border-secondary" value="90"
                                            step="1">
                                        <span
                                            class="input-group-text bg-secondary text-light border-secondary unitsLabel">m</span>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <label class="form-label-xs">Speed</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" id="speed"
                                            class="form-control bg-dark text-light border-secondary" value="9.5"
                                            step="0.1" min="1">
                                        <span class="input-group-text bg-secondary text-light border-secondary"><span
                                                class="unitsLabel">m</span>/s</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="section-title mt-3">
                            <i class="bi bi-camera-video me-1"></i> Action & Orientation
                        </div>
                        <div class="bg-dark border border-secondary rounded p-2 mb-3">
                            <div class="row g-2 mb-2">
                                <div class="col-6">
                                    <label class="form-label-xs">Action</label>
                                    <select id="action"
                                        class="form-select form-select-sm bg-dark text-light border-secondary">
                                        <option value="noAction" class="text-muted">No Action</option>
                                        <option value="takePhoto">Take Photo</option>
                                        <option value="startRecord">Start Recording</option>
                                        <option value="stopRecord">Stop Recording</option>
                                        <option value="gimbalRotate">Rotate Gimbal Only</option>
                                    </select>
                                </div>

                                <div class="col-6">
                                    <label class="form-label-xs text-warning d-flex align-items-center"
                                        title="Angle when performing action">
                                        <i class="bi bi-camera-video me-1"></i> Action Gimbal Pitch
                                    </label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" id="actionGimbalPitch"
                                            class="form-control bg-dark text-light border-secondary" value="-90"
                                            max="30" min="-90">
                                        <span class="input-group-text bg-secondary border-secondary text-light">°</span>
                                    </div>
                                </div>

                                <div class="col-8 mt-1">
                                    <label class="form-label-xs">Aircraft Heading</label>
                                    <select id="headingMode"
                                        class="form-select form-select-sm bg-dark text-light border-secondary">
                                        <option value="auto">Auto (Editable)</option>
                                        <option value="autoDJI">Auto (DJI)</option>
                                        <option value="fixed">Fixed Angle</option>
                                    </select>
                                </div>
                                <div class="col-4 mt-1">
                                    <label class="form-label-xs" id="headingAngleLabel"
                                        style="display:none;">Angle</label>
                                    <div id="headingInputDiv" style="display:none;">
                                        <div class="input-group input-group-sm">
                                            <input type="number" id="headingAngle"
                                                class="form-control bg-dark text-light border-secondary" value="0"
                                                placeholder="0">
                                            <span
                                                class="input-group-text bg-secondary text-light border-secondary">°</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="section-title mt-3"><i class="bi bi-camera me-1"></i> Photogrammetry Auto-Calc</div>
                        <div class="bg-dark border border-secondary rounded p-2 mb-3">
                            <div class="row g-1">
                                <div class="col-6 mt-1">
                                    <label class="form-label-xs">Side Overlap %</label>
                                    <input type="number" id="sideOverlap"
                                        class="form-control form-control-sm bg-dark text-light border-secondary"
                                        value="70" max="90" min="10">
                                </div>
                                <div class="col-6 mt-1">
                                    <label class="form-label-xs">Front Overlap %</label>
                                    <input type="number" id="frontOverlap"
                                        class="form-control form-control-sm bg-dark text-light border-secondary"
                                        value="70" max="90" min="10">
                                </div>
                                <div class="col-12 mt-2">
                                    <div class="d-grid">
                                        <button type="button" id="btnAutoCalc" class="btn btn-outline-info btn-sm"
                                            disabled>
                                            <i class="bi bi-calculator me-1"></i> Apply to Settings
                                        </button>
                                    </div>
                                </div>
                                <div class="col-12 mt-1 text-center">
                                    <small class="text-muted" style="font-size: 0.7rem;">
                                        GSD: <span id="gsdDisplay" class="text-light">-</span> <span
                                            id="gsdUnit">cm/px</span> |
                                        Footprint: <span id="footprintDisplay" class="text-light">-</span> <span
                                            id="footprintUnit">m</span>
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="section-title mt-3">
                            <i class="bi bi-map me-1"></i> Flight Path
                        </div>
                        <div class="bg-dark border border-secondary rounded p-2 mb-3">
                            <div class="row g-1 mb-2">
                                <div class="col-12">
                                    <small class="text-secondary fw-bold text-uppercase"
                                        style="font-size: 0.65rem;">Waypoints &amp; Placement</small>
                                </div>
                                <div class="col-4">
                                    <label class="form-label-xs">Side Spacing</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" id="spacing"
                                            class="form-control bg-dark text-light border-secondary" value="50" step="1"
                                            min="1">
                                        <span
                                            class="input-group-text bg-secondary text-light border-secondary unitsLabel">m</span>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <label class="form-label-xs">Point Interval</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" id="interval"
                                            class="form-control bg-dark text-light border-secondary" value="3"
                                            step="0.1" min="0.1">
                                        <span
                                            class="input-group-text bg-secondary text-light border-secondary unitsLabel">s</span>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <label class="form-label-xs">Direction</label>
                                    <select id="lineDirection"
                                        class="form-select form-select-sm bg-dark text-light border-secondary">
                                        <option value="auto">Auto</option>
                                        <option value="ew">East-West</option>
                                        <option value="ns">North-South</option>
                                    </select>
                                </div>
                            </div>

                            <hr class="border-secondary my-2 opacity-50">

                            <div class="mb-2">
                                <label class="form-label-xs">Turn Mode</label>
                                <select id="turnMode"
                                    class="form-select form-select-sm bg-dark text-light border-secondary"
                                    data-bs-toggle="tooltip" title="Defines how drone handles corners">
                                    <option value="toPointAndStopWithContinuityCurvature" selected>Curved Stop
                                        (Default)
                                    </option>
                                    <option value="coordinateTurn">Coordinate Turn (Fast)</option>
                                    <option value="toPointAndStopWithDiscontinuityCurvature">Straight Stop (Sharp)
                                    </option>
                                    <option value="toPointAndPassWithContinuityCurvature">Curved Pass (Smooth)
                                    </option>
                                </select>
                                <div id="turnModeHelp" class="text-secondary"
                                    style="font-size: 0.7rem; margin-top: 2px;">
                                    Curved entry, stop at point.</div>
                            </div>

                            <div class="mb-2">
                                <label class="form-label-xs">Finish Action</label>
                                <select id="finalAction"
                                    class="form-select form-select-sm bg-dark text-light border-secondary">
                                    <option value="return">Return to Home</option>
                                    <option value="hover">Hover</option>
                                    <option value="land">Auto Land</option>
                                </select>
                            </div>

                            <div class="form-check form-switch form-check-sm">
                                <input type="checkbox" id="maintainAltitude" class="form-check-input">
                                <label class="form-check-label small text-light" for="maintainAltitude">Terrain
                                    Follow</label>
                            </div>
                            <div class="form-check form-switch form-check-sm mb-3">
                                <input type="checkbox" id="reversePath" class="form-check-input">
                                <label class="form-check-label small text-light" for="reversePath">Reverse
                                    Path</label>
                            </div>

                            <button type="button" id="generateFromAdvanced"
                                class="btn btn-success btn-sm w-100 fw-bold">
                                <i class="bi bi-bezier2 me-1"></i> Generate Waypoints
                            </button>
                        </div>
                    </form>
                </div>

                <div class="tab-pane fade" id="tab-export" role="tabpanel">
                    <div class="compact-form">
                        <div class="section-title">Mission Info</div>
                        <div class="bg-dark border border-secondary rounded p-2 mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-secondary small">Count:</span>
                                <span class="text-light fw-bold small" id="wpCount">0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-secondary small">Dist:</span>
                                <span class="text-info fw-bold small" id="totalDist">0 m</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="text-secondary small">Time:</span>
                                <span class="text-warning fw-bold small" id="etaTime">0 s</span>
                            </div>
                        </div>



                        <div class="mb-3">
                            <label class="form-label-xs">Mission Name</label>
                            <input type="text" id="missionName"
                                class="form-control form-control-sm bg-dark text-light border-secondary"
                                value="DJI_Mission">
                        </div>

                        <div class="alert alert-warning py-1 px-2 small mb-3 d-flex align-items-center"
                            id="waypointWarning" style="display:none; font-size: 0.75rem;">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i> >100 WPs may lag controller.
                        </div>

                        <div class="d-grid gap-2">
                            <button id="downloadKmz" class="btn btn-primary btn-sm" disabled>
                                <i class="bi bi-download me-1"></i> Download KMZ
                            </button>
                            <button id="downloadJson" class="btn btn-outline-secondary btn-sm" disabled>
                                <i class="bi bi-file-code me-1"></i> JSON Debug
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Map Container -->
        <div class="editor-map-container" id="map-container">
            <div id="mapToast" class="map-toast">Calculation successful</div>
            <div id="map" class="h-100 w-100"></div>
        </div>

    </div>
    <!-- End editor-main -->

    <div class="modal fade" id="helpModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content bg-dark text-light border-secondary">
                <div class="modal-header border-secondary py-2">
                    <h6 class="modal-title">Shortcuts</h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body small p-3">
                    <div class="d-flex justify-content-between mb-1"><span>Polygon</span> <kbd
                            class="bg-secondary">Ctrl+1</kbd></div>
                    <div class="d-flex justify-content-between mb-1"><span>Rectangle</span> <kbd
                            class="bg-secondary">Ctrl+2</kbd></div>
                    <div class="d-flex justify-content-between mb-1"><span>Circle</span> <kbd
                            class="bg-secondary">Ctrl+3</kbd></div>
                    <hr class="border-secondary my-2">
                    <div class="d-flex justify-content-between mb-1"><span>Undo</span> <kbd
                            class="bg-secondary">Ctrl+Z</kbd></div>
                    <div class="d-flex justify-content-between"><span>Redo</span> <kbd
                            class="bg-secondary">Ctrl+Alt+Z</kbd>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="lib/leaflet/leaflet-src.js"></script>

    <div class="modal fade" id="proModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-light border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title"><i class="bi bi-star-fill text-warning me-2"></i>Upgrade to Pro</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <h3 id="planName">Loading...</h3>
                    <p id="planDesc" class="text-secondary">Please wait...</p>
                    <h2 id="planPrice" class="text-info my-3"></h2>

                    <div class="d-grid gap-2 mt-4">
                        <button id="btnSubscribe" class="btn btn-primary btn-lg" disabled>
                            Subscribe Now
                        </button>
                    </div>
                    <small class="text-muted mt-2 d-block">Secured by Stripe</small>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script src="history.js"></script>
    <script src="kmz-generator.js"></script>
    <script src="drone-specs.js"></script>
    <script src="waypoint-popup.js"></script>
    <script src="message-box.js"></script>
    <div class="modal fade" id="authModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content bg-dark text-light border-secondary">
                <div class="modal-header border-secondary py-2">
                    <h6 class="modal-title" id="authModalTitle">Login</h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-3">
                    <ul class="nav nav-pills nav-fill mb-3" id="authTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active py-1" id="tab-login" data-bs-toggle="pill"
                                data-bs-target="#pills-login" type="button" role="tab"
                                onclick="toggleAuthMode('login')">Login</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link py-1" id="tab-register" data-bs-toggle="pill"
                                data-bs-target="#pills-register" type="button" role="tab"
                                onclick="toggleAuthMode('register')">Register</button>
                        </li>
                    </ul>

                    <div class="mb-3">
                        <label for="authEmail" class="form-label-xs">Email</label>
                        <input type="email" class="form-control form-control-sm bg-dark text-light border-secondary"
                            id="authEmail" placeholder="name@example.com">
                    </div>
                    <div class="mb-3">
                        <label for="authPassword" class="form-label-xs">Password</label>
                        <input type="password" class="form-control form-control-sm bg-dark text-light border-secondary"
                            id="authPassword">
                    </div>

                    <div id="authError" class="alert alert-danger py-1 px-2 small mb-3"
                        style="display: none; font-size: 0.75rem;"></div>

                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-sm" type="button" id="authSubmitBtn">Login</button>
                        <button class="btn btn-outline-light btn-sm" type="button" id="googleAuthBtn">
                            <i class="bi bi-google me-1"></i> Sign in with Google
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="drawing-manager.js"></script>
    <script type="module">

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            getDocs,
            collection,
            query,
            where,
            addDoc,
            onSnapshot
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 1. Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAVdsKvhztwtyv_QetEoz1nAXUejE80Sbw",
            authDomain: "waypointeditor-1238f.firebaseapp.com",
            projectId: "waypointeditor-1238f",
            storageBucket: "waypointeditor-1238f.firebasestorage.app",
            messagingSenderId: "135089930451",
            appId: "1:135089930451:web:5069920acadf6e5c695426",
            measurementId: "G-079FSLL95C"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // UI Elements
        const loginBtn = document.getElementById('loginBtn');
        const userProfileDropdown = document.getElementById('userProfileDropdown');
        const currentUserEmail = document.getElementById('currentUserEmail');
        const userProBadge = document.getElementById('userProBadge');
        const logoutBtn = document.getElementById('logoutBtn');
        const upgradeBtn = document.getElementById('upgradeBtn'); // Kept for logic, though button moved/removed in HTML? 
        // Wait, I removed upgradeBtn from HTML above. 
        // Let's add it back into the dropdown or keep it separate? 
        // Plan said "Status" in dropdown. Let's stick to that.

        const btnSubscribe = document.getElementById('btnSubscribe');

        // Auth Modal Elements
        const authModalEl = document.getElementById('authModal');
        const authModal = new bootstrap.Modal(authModalEl);
        const authEmail = document.getElementById('authEmail');
        const authPassword = document.getElementById('authPassword');
        const authSubmitBtn = document.getElementById('authSubmitBtn');
        const googleAuthBtn = document.getElementById('googleAuthBtn');
        const authError = document.getElementById('authError');
        const authModalTitle = document.getElementById('authModalTitle');

        let isLoginMode = true;

        window.toggleAuthMode = (mode) => {
            isLoginMode = mode === 'login';
            authModalTitle.textContent = isLoginMode ? 'Login' : 'Register';
            authSubmitBtn.textContent = isLoginMode ? 'Login' : 'Register';
            authError.style.display = 'none';
        };

        // 全域變數存 Price ID
        let currentPriceId = null;

        // --- A. 登入與權限檢查邏輯 ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // 已登入
                if (loginBtn) loginBtn.style.display = 'none';
                if (userProfileDropdown) userProfileDropdown.style.display = 'block';

                if (currentUserEmail) {
                    currentUserEmail.textContent = user.email;
                }

                // 1. 檢查是否已經訂閱
                checkSubscriptionStatus(user.uid);

                // 2. 預先載入產品資訊給 Modal 用
                loadProductInfo();

                // 將使用者資訊掛載到全域變數
                window.currentUser = user;

            } else {
                // 未登入 -> 無法進入 Pro 版 -> 轉去 Free 版
                window.location.href = 'editorfree.html';
            }
        });

        // 檢查訂閱狀態
        async function checkSubscriptionStatus(uid) {
            const subRef = collection(db, "users", uid, "subscriptions");
            // 找尋狀態為 active 或 trialing 的訂閱
            const q = query(subRef, where("status", "in", ["active", "trialing"]));
            const snapshot = await getDocs(q);

            if (!snapshot.empty) {
                // 是 Pro 用戶 -> 允許留在本頁
                if (userProBadge) {
                    userProBadge.textContent = "PRO";
                    userProBadge.classList.replace('bg-secondary', 'bg-warning');
                    userProBadge.classList.add('text-dark');
                }
                if (upgradeBtn) upgradeBtn.style.display = 'none';
                if (window.app) window.app.isProMember = true;
            } else {
                // 免費 用戶 -> 轉去 Free 版，並帶參數顯示 Upgrade prompt
                window.location.href = 'editorfree.html?showUpgrade=true';
            }
        }

        // --- B. 讀取產品資訊 (顯示在 Modal) ---
        async function loadProductInfo() {
            // 讀取 products 集合中 active: true 的產品
            const q = query(collection(db, "products"), where("active", "==", true));
            const querySnapshot = await getDocs(q);

            querySnapshot.forEach(async (doc) => {
                const product = doc.data();
                // 填寫 UI
                const planName = document.getElementById('planName');
                const planDesc = document.getElementById('planDesc');
                if (planName) planName.textContent = product.name;
                if (planDesc) planDesc.textContent = product.description;

                // 讀取這個產品底下的 prices 子集合
                const priceSnap = await getDocs(collection(db, "products", doc.id, "prices"));
                priceSnap.forEach((priceDoc) => {
                    const price = priceDoc.data();
                    // 找到一個有效的價格
                    if (price.active) {
                        currentPriceId = priceDoc.id; // 記下 Price ID 供結帳用
                        const amount = (price.unit_amount / 100).toFixed(0); // Stripe 金額是「分」，要除以 100
                        const currency = price.currency.toUpperCase();
                        const planPrice = document.getElementById('planPrice');
                        if (planPrice) planPrice.textContent = `${currency} $${amount} / month`;

                        // 啟用按鈕
                        if (btnSubscribe) btnSubscribe.disabled = false;
                    }
                });
            });
        }

        // --- C. 觸發結帳 (核心功能) ---
        if (btnSubscribe) {
            btnSubscribe.addEventListener('click', async () => {
                if (!auth.currentUser) return;
                if (!currentPriceId) {
                    alert("Error: No price ID found");
                    return;
                }

                btnSubscribe.textContent = "Redirecting...";
                btnSubscribe.disabled = true;

                // 1. 在 users/{uid}/checkout_sessions 建立新文件
                // 這是告訴 Firebase Extension：「我要結帳！」
                try {
                    const sessionRef = await addDoc(collection(db, "users", auth.currentUser.uid, "checkout_sessions"), {
                        price: currentPriceId,
                        success_url: window.location.href, // 付款成功後跳轉回原頁面
                        cancel_url: window.location.href,  // 取消付款也跳回原頁面
                    });

                    // 2. 監聽這個文件，等待 Extension 回傳 Stripe 的付款網址 (url)
                    onSnapshot(sessionRef, (snap) => {
                        const data = snap.data();
                        if (!data) return;
                        const { error, url } = data;
                        if (error) {
                            // 發生錯誤
                            alert(`An error occurred: ${error.message}`);
                            btnSubscribe.textContent = "Subscribe Now";
                            btnSubscribe.disabled = false;
                        }
                        if (url) {
                            // 3. 拿到網址，跳轉去 Stripe
                            window.location.assign(url);
                        }
                    });
                } catch (e) {
                    console.error("Checkout Error:", e);
                    alert("Checkout failed: " + e.message);
                    btnSubscribe.textContent = "Subscribe Now";
                    btnSubscribe.disabled = false;
                }
            });
        }

        // 登入登出按鈕事件
        // if (loginBtn) loginBtn.addEventListener('click', () => signInWithPopup(auth, provider)); // OLD
        if (loginBtn) {
            loginBtn.addEventListener('click', () => {
                authModal.show();
            });
        }

        if (logoutBtn) logoutBtn.addEventListener('click', () => signOut(auth).then(() => window.location.reload()));

        // auth 處理函式
        async function handleAuth() {
            const email = authEmail.value;
            const password = authPassword.value;
            authError.style.display = 'none';
            authError.textContent = '';

            try {
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    await createUserWithEmailAndPassword(auth, email, password);
                }
                authModal.hide();
            } catch (error) {
                authError.innerText = error.message;
                authError.style.display = 'block';
            }
        }

        if (authSubmitBtn) {
            authSubmitBtn.addEventListener('click', handleAuth);
        }

        if (googleAuthBtn) {
            googleAuthBtn.addEventListener('click', async () => {
                try {
                    await signInWithPopup(auth, provider);
                    authModal.hide();
                } catch (error) {
                    authError.innerText = error.message;
                    authError.style.display = 'block';
                }
            });
        }
        if (logoutBtn) logoutBtn.addEventListener('click', () => signOut(auth).then(() => window.location.reload()));
    </script>

    <script src="scripts/calculator.js"></script>
    <script src="app.js"></script>
</body>

</html>